<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.7.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.7.0/ol.css">

    <style>
      body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #0f172a; }
      #map { width: 100%; height: 100%; }

      /* --- FUTURISTIC MARKER CSS --- */
      .marker-container {
        position: relative;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* The solid center dot */
      .user-dot {
        width: 16px;
        height: 16px;
        background-color: #3b82f6; /* Blue-500 */
        border: 3px solid #ffffff;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        z-index: 2;
      }

      /* The ripple animation rings */
      .pulse-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: rgba(59, 130, 246, 0.6);
        opacity: 0;
        z-index: 1;
        animation: ripple 2s infinite ease-out;
      }

      /* A second ring with a delay for a continuous radar effect */
      .pulse-ring:nth-child(2) {
        animation-delay: 0.6s;
      }

      @keyframes ripple {
        0% {
          transform: scale(0.5);
          opacity: 0.8;
        }
        100% {
          transform: scale(3.5);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Hidden template for the overlay -->
    <div id="user-marker" style="display: none;">
      <div class="marker-container">
        <div class="pulse-ring"></div>
        <div class="pulse-ring"></div>
        <div class="user-dot"></div>
      </div>
    </div>

    <script>
      let map;
      let streetLayer;
      let satelliteLayer;
      let userOverlay; // Using Overlay instead of Vector Layer for CSS animations

      function initMap() {
        // 1. Sources
        streetLayer = new ol.layer.Tile({
          source: new ol.source.OSM(),
          visible: true
        });

        satelliteLayer = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            maxZoom: 19,
            attributions: 'Tiles Â© Esri'
          }),
          visible: false
        });

        // 2. Create Overlay (The DOM element)
        const markerEl = document.getElementById('user-marker');
        markerEl.style.display = 'block'; // Make visible once moved into map

        userOverlay = new ol.Overlay({
          element: markerEl,
          positioning: 'center-center',
          stopEvent: false 
        });

        // 3. Create Map
        map = new ol.Map({
          target: 'map',
          layers: [streetLayer, satelliteLayer],
          overlays: [userOverlay], // Add overlay here
          view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 2
          }),
          controls: ol.control.defaults.defaults({ zoom: false, attribution: false })
        });

        sendToRN({ type: 'MAP_READY' });
      }

      function updateMapState(data) {
        if (!map) return;
        const view = map.getView();

        // Update Location
        if (data.lat !== undefined && data.lng !== undefined) {
          const coords = ol.proj.fromLonLat([data.lng, data.lat]);
          view.animate({ center: coords, duration: 400 });
          
          if (data.showMarker) {
            userOverlay.setPosition(coords);
            document.getElementById('user-marker').style.display = 'flex';
          } else {
            userOverlay.setPosition(undefined); // Hide it
            document.getElementById('user-marker').style.display = 'none';
          }
        }

        // Update Zoom
        if (data.zoom !== undefined) {
           view.animate({ zoom: data.zoom, duration: 400 });
        }

        // Update Source
        if (data.source === 'satellite-view') {
          satelliteLayer.setVisible(true);
          streetLayer.setVisible(false);
        } else {
          satelliteLayer.setVisible(false);
          streetLayer.setVisible(true);
        }
      }

      function sendToRN(payload) {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        }
      }

      window.handleRNMessage = function(jsonString) {
        try {
          const data = JSON.parse(jsonString);
          updateMapState(data);
        } catch (e) { console.error(e); }
      };

      document.addEventListener('DOMContentLoaded', initMap);
    </script>
  </body>
</html>